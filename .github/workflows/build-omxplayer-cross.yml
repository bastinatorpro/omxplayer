name: Build omxplayer for ARMv6 with host-side userland

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore cached userland
        uses: actions/cache@v3
        with:
          path: opt
          key: userland-opt-v1

      - name: Build userland on host
        run: |
          if [ ! -f opt/vc/lib/libWFC.so ]; then
            git clone https://github.com/raspberrypi/userland
            cd userland
            ./buildme
            mkdir -p ../opt
            cp -r opt/* ../opt/
          fi

      - name: Build omxplayer inside ARMv6 container
        run: |
          docker run --rm --platform linux/arm/v6 \
            -v ${{ github.workspace }}:/workspace \
            -v ${{ github.workspace }}/opt:/opt \
            -w /workspace \
            balenalib/rpi-debian:bullseye bash -c "
              set -e
              set -x

              apt update
              apt install -y git build-essential cmake crossbuild-essential-armhf \
                libboost-dev libpcre3-dev libcrossguid-dev libudev-dev \
                libasound2-dev libdrm-dev libfreetype6-dev libfontconfig1-dev \
                libssl-dev libcurl4-openssl-dev ruby ruby-dev \
                ffmpeg libavcodec-dev libavformat-dev libavutil-dev \
                libswscale-dev libswresample-dev libavfilter-dev

              gem install --no-document fpm

              git clone https://github.com/popcornmix/omxplayer
              cd omxplayer

              # Удаляем устаревший путь и добавляем правильный
              sed -i '/ffmpeg_compiled.*include/d' Makefile.include
              echo '-I/usr/include/arm-linux-gnueabihf' >> Makefile.include

              # Проверка наличия channel_layout.h
              test -f /usr/include/arm-linux-gnueabihf/libavutil/channel_layout.h || (echo 'FFmpeg headers missing!' && exit 1)

              export VC_PATH=/opt/vc
              export LD_LIBRARY_PATH=\$VC_PATH/lib
              make -j2 CC=arm-linux-gnueabihf-gcc CXX=arm-linux-gnueabihf-g++

              mkdir -p deb/usr/bin
              cp omxplayer.bin deb/usr/bin/omxplayer
              fpm -s dir -t deb -n omxplayer -v 0.3.7 --architecture armhf --prefix=/ -C deb .
              mv *.deb /workspace/
            "

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: omxplayer-armv6-deb
          path: omxplayer_*.deb
